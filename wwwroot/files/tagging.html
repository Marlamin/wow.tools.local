<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
    <title>WoW.tools - Tagging</title>
    <meta property='og:type' content='website'>
    <meta property='og:site_name' content='WoW.tools'>
    <meta property='og:title' content='WoW.tools'>
    <meta property='og:image' content='/img/cogw.png'>
    <meta property='twitter:image' content='/img/cogw.png'>
    <meta property='twitter:card' content='summary'>
    <meta property='twitter:site' content='@Marlamin'>
    <meta name='application-name' content='WoW.tools'>
    <meta name='apple-mobile-web-app-title' content='WoW.tools'>
    <meta name='theme-color' content='#343a40'>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon" type="image/png" href="/img/cogw.png" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/css/font-awesome.min.css" />

    <!-- JQuery -->
    <script src="/js/jquery.min.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/bootstrap.bundle.min.js"></script>

    <!-- Datatables -->
    <link rel="stylesheet" type="text/css" href="/css/datatables.min.css" />
    <script type="text/javascript" src="/js/datatables.min.js"></script>
    <script src="/js/input.js" crossorigin="anonymous"></script>

    <link href="/css/style.css?v=1661289414" rel="stylesheet">
    <script type="text/javascript" src="/js/main.js"></script>
    <script type="text/javascript" src="/js/anims.js"></script>
    <script type="text/javascript" src="/js/bufo.js"></script>
    <script type="text/javascript" src="/js/js-blp.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg" id="navbar"></nav>
    <div class="container-fluid" id='tagging_container'>
        <div class="row">
            <div class="col-md-2">
                <button id="saveRepositoryButton" class="btn btn-success form-control" style="margin: 0px;">Save changes to disk</button>
            </div>
            <div class="col-md-8">
                <div id="changeWarning" class="alert alert-warning" style="display: none; margin: 0px; padding: 5px; padding-left: 10px;height: 38px;">
                    You have unsaved changes. Press the button on the left to save the changes to disk.
                </div>
            </div>
            <div class="col-md-2">
                <button id="reloadRepositoryButton" class="btn btn-danger form-control" style="margin: 0px;">Discard changes & reload from disk</button>
            </div>
        </div>
        <br />
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link" id="tagging-tab" data-bs-toggle="tab" href="#tagging" role="tab" aria-controls="tagging" aria-selected="false">Manual Tagging</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" id="manageTags-tab" data-bs-toggle="tab" href="#manageTags" role="tab" aria-controls="manageTags" aria-selected="false">Manage Tags</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="automatic-tab" data-bs-toggle="tab" href="#automatic" role="tab" aria-controls="automatic" aria-selected="false">Auto Tagging</a>
            </li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane" id="tagging" role="tabpanel" aria-labelledby="tagging-tab">
                Tagging
            </div>
            <div class="tab-pane show active" id="manageTags" role="tabpanel" aria-labelledby="manageTags-tab">
                <div class="row">
                    <div class="col-md-4">
                        <h4>Current tags</h4>
                        <table id="tagTable" class="table table-striped table-bordered table-condensed" cellspacing="0" style='margin: auto; ' width="100%">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-8">
                        <h4>Add/edit tag</h4>
                        <form id="manageTagForm" method="post" action="#">
                            <div class="row mb-3">
                                <label for="tagKey" class="col-sm-1 col-form-label">Key</label>
                                <div class="col-sm-11">
                                    <input type="text" class="form-control" name="key" id="tagKey" style="background-color: light-dark(rgba(239, 239, 239, 0.3), rgba(59, 59, 59, 0.3)); color: light-dark(rgb(84, 84, 84), rgb(170, 170, 170));" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="tagName" class="col-sm-1 col-form-label">Name</label>
                                <div class="col-sm-11">
                                    <input type="text" class="form-control" name="name" id="tagName">
                                    <div id="nameHelp" class="form-text">Name and key have to be unique. If an existing key is specified, the existing tag will be updated.</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="tagDescription" class="col-sm-1 col-form-label">Description</label>
                                <div class="col-sm-11">
                                    <input type="text" class="form-control" name="description" id="tagDescription">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="tagCategory" class="col-sm-1 col-form-label">Category</label>
                                <div class="col-sm-11">
                                    <select class="form-control" id="tagCategory" name="category">
                                        <option>Classification</option>
                                        <option>Historical</option>
                                        <option>Technical</option>
                                        <option>Location</option>
                                        <option>Metadata</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-11 offset-sm-1">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="allowMultipleCheck">
                                        <label class="form-check-label" for="allowMultipleCheck">
                                            Allow multiple values for this tag per file
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-11 offset-sm-1">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="presetCheck">
                                        <label class="form-check-label" for="presetCheck">
                                            This tag is limited to preset options
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-sm-11 offset-sm-1">
                                    <div id="presetFormHolder" style="display: none">
                                        <h5>Add/edit presets <a class="btn btn-sm btn-primary" id="addPresetRowButton">Add Row</a></h5>
                                        <div id="presetForm" style="max-height: 265px; overflow-y: scroll; overflow-x: hidden">

                                        </div>
                                    </div>
                                </div>
                            </div>
                      
                            <button type="submit" id="saveTagButton" class="btn btn-success">Save</button>
                            <button type="reset" id="cancelButton" class="btn btn-danger">Reset</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="automatic" role="tabpanel" aria-labelledby="automatic-tab">
                TODO: Automatic Tagging
            </div>
        </div>
        <script type="text/javascript">
            Elements = {};
            let page = 0;
            Elements.table = $('#tagTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    url: '/tags/table',
                    type: 'GET'
                },
                "pageLength": 15,
                "language": {
                    "search": "Search: _INPUT_",
                    "info": "_START_ to _END_ of _TOTAL_ tags",
                    "infoFiltered": ""
                },
                "displayStart": page * 15,
                "autoWidth": false,
                "lengthMenu": [
                    [15, 25, 50, 100, 1000, -1],
                    [15, 25, 50, 100, 1000, "All"]
                ],
                "ordering": false,
                "orderMulti": false,
            });

            $("#tagTable").on('click', 'tbody tr td', function () {
                var data = Elements.table.row($(this).parent()).data();

                $(".selected").removeClass("selected");
                $(this).parent().addClass('selected');

                Elements.currentID = data[0];
                loadTag(data[0]);
            });

            const manageTagForm = document.getElementById("manageTagForm");

            document.getElementById("saveRepositoryButton").onclick = function (e) {
                fetch("/tags/save")
                    .then(response => {
                        checkForChanges();
                    });
            }

            document.getElementById("reloadRepositoryButton").onclick = function (e) {
                fetch("/tags/reload")
                    .then(response => {
                        checkForChanges();
                        Elements.table.ajax.reload();
                        manageTagForm.reset();
                        refreshPresetForm();
                    });
            }

            document.getElementById("addPresetRowButton").onclick = function (e) {
                addPresetFormRow("", "", "");
            }

            document.getElementById("presetCheck").onchange = function (e) {
                refreshPresetForm();
            }

            document.getElementById("tagName").oninput = function (e) {
                document.getElementById("tagKey").value = document.getElementById("tagName").value.replace(/[^a-zA-Z0-9]/g, '');
            }

            function refreshPresetForm() {
                const presetFormHolder = document.getElementById("presetFormHolder");

                if (document.getElementById("presetCheck").checked) {
                    presetFormHolder.style.display = "block";
                } else {
                    presetFormHolder.style.display = "none";
                }
            }

            function checkForChanges() {
                fetch("/tags/changeStatus")
                    .then(response => {
                        return response.json();
                    })
                    .then(json => {
                        if (json.unsavedChanges) {
                            saveRepositoryButton.classList.remove("disabled");
                            changeWarning.style.display = 'block';
                        } else {
                            saveRepositoryButton.classList.add("disabled");
                            changeWarning.style.display = 'none';
                        }
                    });
            }

            checkForChanges();

            function loadTag(tagKey)
            {
                fetch("/tags/list?tagKey=" + tagKey)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("HTTP error: " + response.status);
                        }
                        return response.json();
                    })
                    .then(tags => {
                        document.getElementById("tagName").value = tags[0].name;
                        document.getElementById("tagKey").value = tags[0].key;
                        document.getElementById("tagDescription").value = tags[0].description;
                        document.getElementById("tagCategory").value = tags[0].category;

                        document.getElementById("presetCheck").checked = tags[0].type == 0;
                        if (tags[0].type == 0) {
                            // Load presets
                            presetForm.innerHTML = "";
                            console.log(tags[0].presets);

                            for (let i = 0; i < tags[0].presets.length; i++) {
                                var preset = tags[0].presets[i];
                                addPresetFormRow(preset.option, preset.description, preset.aliases);
                            }

                            addPresetFormRow("", "", "");
                        }
                        document.getElementById("allowMultipleCheck").checked = tags[0].allowMultiple;

                        refreshPresetForm();
                    })
                    .catch((e) => {
                        console.log(e)
                    });
            }

            function addPresetFormRow(option, description, aliases) {
                let numPresetRows = document.getElementsByClassName("presetRows").length;

                var newRow = document.createElement("div");
                newRow.classList = ["row g-3 presetRows"];
                let rowHTML = '<div class="col-sm-3">';
                rowHTML += '<input type="text" class="form-control" name="presetOption[' + numPresetRows + ']" placeholder="Option" aria-label="Option" value="' + option + '">';
                rowHTML += '</div>';
                rowHTML += '<div class="col-sm-6">';
                rowHTML += '<input type="text" class="form-control" name="presetDescription[' + numPresetRows + ']" placeholder="Description" aria-label="Description" value="' + description + '">';
                rowHTML += '</div>';
                rowHTML += '<div class="col-sm-3">';
                rowHTML += '<input type="text" class="form-control" name="presetAliases[' + numPresetRows + ']" placeholder="Aliases (comma-separated)" aria-label="Aliases" value="' + aliases + '">';
                rowHTML += '</div>';

                newRow.innerHTML = rowHTML;
                presetForm.appendChild(newRow);
            }

            manageTagForm.onsubmit = function (e) {
                e.preventDefault();
         
                var data = new FormData(manageTagForm);

                if (document.getElementById("presetCheck").checked) {
                    data.append("type", "Preset");
                } else {
                    data.append("type", "Custom");
                }

                if (document.getElementById("allowMultipleCheck").checked) {
                    data.append("allowMultiple", "True");
                } else {
                    data.append("allowMultiple", "False");
                }

                fetch('/tags/updateTag', {
                    method: 'POST',
                    body: data,
                }).then(function (response) {
                    return response.text();
                }).then(function (data) {

                    // Save presets

                    manageTagForm.reset();
                    presetForm.innerHTML = "";
                    refreshPresetForm();
                    checkForChanges();
                    Elements.table.ajax.reload();
                });
            }

            document.getElementById("cancelButton").onclick = function (e) {
                e.preventDefault();
                $(".selected").removeClass("selected");
                Elements.currentID = "";
                manageTagForm.reset();
                presetForm.innerHTML = "";
                refreshPresetForm();
            }
        </script>
        <script src="/js/files.js"></script>
        <link href="/css/files.css" rel="stylesheet">
    </div>
</body>
</html>

